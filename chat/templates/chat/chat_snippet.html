{% if user.is_authenticated %}
<div id="chat-container" style="position: fixed; bottom: 20px;">
  <div id="chat-box" style="display: block; border: 2px solid #72bb53; border-radius: 10px; padding: 10px; background-color: white; width: 300px; height: 400px; overflow-y: auto;">
    <div id="messages"></div>
    <input type="text" id="message-input" placeholder="Escribe tu mensaje..." />
    <button id="send-button" style="background-color: #72bb53; color: white; border: none; padding: 8px 12px; border-radius: 5px; margin-top: 5px;">Enviar</button>
  </div>
  <button id="chat-button" style="background-color: #72bb53; color: white; border: none; padding: 8px 12px; border-radius: 5px;">Chat</button>
</div>
<script>
  // Asignamos el nombre del usuario desde Django
  const username = "{{ user.username|escapejs }}";

  // Elementos del DOM
  const chatButton = document.getElementById("chat-button");
  const chatBox = document.getElementById("chat-box");
  const messagesDiv = document.getElementById("messages");
  const messageInput = document.getElementById("message-input");
  const sendButton = document.getElementById("send-button");

  // Alterna la visibilidad del chat
  chatButton.addEventListener("click", () => {
    chatBox.style.display = chatBox.style.display === "none" ? "block" : "none";
  });

  // Envio del mensaje con el username incluido
  sendButton.addEventListener("click", () => {
    const message = messageInput.value.trim();
    if (message) {
      const msgObj = { username: username, message: message };
      appendMessage(msgObj);
      saveMessage(msgObj);
      messageInput.value = "";
    }
  });

  // FunciÃ³n para agregar un mensaje al chat mostrando el nombre a la izquierda
  function appendMessage(msgObj) {
    const messageElement = document.createElement("div");
    const usernameSpan = document.createElement("span");
    usernameSpan.textContent = msgObj.username + ": ";
    usernameSpan.style.fontWeight = "bold";
    const textSpan = document.createElement("span");
    textSpan.textContent = msgObj.message;
    messageElement.appendChild(usernameSpan);
    messageElement.appendChild(textSpan);
    messagesDiv.appendChild(messageElement);
  }

  // Guarda el mensaje en localStorage como un objeto
  function saveMessage(msgObj) {
    let messages = JSON.parse(localStorage.getItem("chatMessages")) || [];
    messages.push(msgObj);
    localStorage.setItem("chatMessages", JSON.stringify(messages));
  }

  // Carga los mensajes almacenados en localStorage y los muestra en el chat
  function loadMessages() {
    let messages = JSON.parse(localStorage.getItem("chatMessages")) || [];
    messages.forEach((msgObj) => {
      appendMessage(msgObj);
    });
  }

  window.onload = loadMessages;
</script>
{% endif %}